<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>李雅瑄的业务运营分析助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            background-color: white;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        .funnel-container {
            width: 100%;
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .funnel-chart-svg {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">李雅瑄的业务运营分析助手</h1>
        <p class="text-sm text-gray-500 mt-2">
            （此Demo模拟分析美团骑手配送数据，请上传CSV文件）
        </p>
    </div>

    <!-- Upload, Analysis Options, and Action Buttons -->
    <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mb-8">
        <div class="w-full md:w-auto">
            <label for="file-upload" class="cursor-pointer bg-[#FFD100] hover:bg-[#FFC600] text-gray-800 font-semibold py-2 px-4 rounded-full transition-colors duration-200 shadow-lg">
                上传运营数据表 (CSV)
            </label>
            <input id="file-upload" type="file" accept=".csv" class="hidden">
        </div>
        <div class="w-full md:w-auto">
            <select id="analysis-focus-select" class="w-full md:w-auto bg-white border border-gray-300 rounded-full py-2 px-4 text-gray-700">
                <option value="all">全面数据分析 (默认)</option>
                <option value="efficiency">配送效率分析</option>
                <option value="funnel">用户漏斗分析</option>
                <option value="retention">骑手留存分析</option>
            </select>
        </div>
        <button id="analyze-btn" class="w-full md:w-auto bg-[#4299E1] hover:bg-[#3283C6] text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200 shadow-lg" disabled>
            开始分析
        </button>
        <button id="reset-btn" class="w-full md:w-auto bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-full transition-colors duration-200 shadow-lg hidden">
            重置
        </button>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="hidden border-l-4 p-4 rounded-md mb-6" role="alert">
        <p id="message-text" class="text-sm font-medium"></p>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-spinner" class="hidden flex justify-center items-center my-8">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <!-- Analysis Results Section -->
    <div id="analysis-results" class="hidden">
        <h2 class="text-xl font-bold text-gray-700 mb-6">AI分析报告</h2>

        <!-- Key Metrics -->
        <div id="key-metrics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-50 p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm">订单总数</p>
                <h3 id="total-orders" class="text-xl font-semibold text-gray-800 mt-1">N/A</h3>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm">平均配送时长</p>
                <h3 id="avg-delivery-time" class="text-xl font-semibold text-gray-800 mt-1">N/A</h3>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm">准时率</p>
                <h3 id="on-time-rate" class="text-xl font-semibold text-gray-800 mt-1">N/A</h3>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm">用户好评率</p>
                <h3 id="positive-review-rate" class="text-xl font-semibold text-gray-800 mt-1">N/A</h3>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm">骑手平均在线时长</p>
                <h3 id="avg-online-hours" class="text-xl font-semibold text-gray-800 mt-1">N/A</h3>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm">客单价</p>
                <h3 id="avg-order-value" class="text-xl font-semibold text-gray-800 mt-1">N/A</h3>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8" id="charts-container">
            <!-- Charts will be dynamically inserted here -->
        </div>
        
        <!-- AI Generated Report -->
        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">AI总结与建议</h3>
            <div id="ai-report-text" class="prose max-w-none text-gray-600">
                <!-- AI report content will be inserted here -->
            </div>
            <div class="flex items-center mt-6">
                <button id="copy-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-full transition-colors duration-200 text-sm">
                    复制报告到剪贴板
                </button>
                <span id="copy-message" class="ml-4 text-green-600 text-sm hidden">已复制！</span>
            </div>
        </div>
    </div>
</div>

<script>
    // Global API key for all fetches
    const apiKey = "";
    Chart.register(ChartDataLabels);
    
    document.addEventListener('DOMContentLoaded', () => {
        const fileInput = document.getElementById('file-upload');
        const analyzeBtn = document.getElementById('analyze-btn');
        const resetBtn = document.getElementById('reset-btn');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const analysisResults = document.getElementById('analysis-results');
        const copyBtn = document.getElementById('copy-btn');
        const copyMessage = document.getElementById('copy-message');
        const analysisFocusSelect = document.getElementById('analysis-focus-select');
        const chartsContainer = document.getElementById('charts-container');

        let rawData = null;
        let charts = {};

        const initialMetrics = {
            'total-orders': 'N/A',
            'avg-delivery-time': 'N/A',
            'on-time-rate': 'N/A',
            'positive-review-rate': 'N/A',
            'avg-online-hours': 'N/A',
            'avg-order-value': 'N/A'
        };

        const requiredHeaders = ['订单ID', '订单状态', '配送时长(min)', '是否准时', '用户评价', '客单价', '骑手ID', '在线时长(h)', '骑手收入'];

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                analyzeBtn.disabled = true;
                resetBtn.classList.add('hidden');
                return;
            }

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: (results) => {
                    const headers = results.meta.fields;
                    const hasRequiredHeaders = requiredHeaders.every(header => headers.includes(header));
                    
                    if (!hasRequiredHeaders) {
                        showMessage('数据表格式不正确。请确保包含以下指标: ' + requiredHeaders.join(', ') + '。', 'error');
                        rawData = null;
                        analyzeBtn.disabled = true;
                        resetBtn.classList.add('hidden');
                    } else {
                        showMessage(`已选择文件: ${file.name}`, 'info');
                        rawData = results.data;
                        analyzeBtn.disabled = false;
                        resetBtn.classList.remove('hidden');
                        analyzeData(); // Call analyze immediately after file upload
                    }
                },
                error: (err) => {
                    showMessage('文件解析失败，请确保文件格式正确。', 'error');
                    rawData = null;
                    analyzeBtn.disabled = true;
                    resetBtn.classList.add('hidden');
                }
            });
        });

        // Add event listener to the dropdown for instant analysis
        analysisFocusSelect.addEventListener('change', () => {
            if (rawData) {
                analyzeData();
            }
        });

        analyzeBtn.addEventListener('click', async () => {
            if (!rawData) {
                showMessage('请先上传数据文件。您可以下载并上传示例数据进行体验。', 'error');
                return;
            }
            analyzeData();
        });

        async function analyzeData() {
            showMessage('正在分析数据，请稍候...', 'info');
            analysisResults.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            const analysisFocus = analysisFocusSelect.value;
            const structuredData = processData(rawData);
            
            updateMetricsAndCharts(structuredData, analysisFocus);

            const prompt = createAIPrompt(structuredData, analysisFocus);
            const report = await fetchAIReport(prompt);
            document.getElementById('ai-report-text').innerHTML = report;

            loadingSpinner.classList.add('hidden');
            analysisResults.classList.remove('hidden');
            showMessage('分析完成！', 'success');
        }

        resetBtn.addEventListener('click', () => {
            fileInput.value = '';
            analyzeBtn.disabled = true;
            resetBtn.classList.add('hidden');
            analysisResults.classList.add('hidden');
            messageBox.classList.add('hidden');
            rawData = null;
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            updateMetricsDisplay(initialMetrics);
        });

        copyBtn.addEventListener('click', () => {
            const reportText = document.getElementById('ai-report-text').innerText;
            try {
                const textArea = document.createElement('textarea');
                textArea.value = reportText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                copyMessage.classList.remove('hidden');
                setTimeout(() => {
                    copyMessage.classList.add('hidden');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                alert('报告内容无法复制。请手动复制。');
            }
        });

        function showMessage(text, type) {
            messageText.innerText = text;
            messageBox.classList.remove('hidden');
            messageBox.classList.remove('bg-red-100', 'bg-yellow-100', 'bg-green-100', 'border-red-500', 'border-yellow-500', 'border-green-500', 'text-red-700', 'text-yellow-700', 'text-green-700');
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
            } else {
                messageBox.classList.add('bg-yellow-100', 'border-yellow-500', 'text-yellow-700');
            }
        }

        function processData(data) {
            const processed = {
                metrics: {},
                charts: {
                    deliveryTimeDistribution: [],
                    funnel: {},
                    riderRetention: {},
                    efficiencyScatter: [],
                    orderValueByRegion: {}
                }
            };
            
            // Generate a random subset for processing to avoid performance issues
            const subsetSize = 8000;
            const dataSubset = data.sort(() => 0.5 - Math.random()).slice(0, subsetSize);

            // Calculate core metrics
            const totalOrders = data.length;
            const onTimeOrders = data.filter(row => row['是否准时'] === '是').length;
            const positiveReviews = data.filter(row => row['用户评价'] === '好评').length;
            const validDeliveryTimes = data.map(row => row['配送时长(min)']).filter(time => typeof time === 'number' && !isNaN(time));
            const avgDeliveryTime = validDeliveryTimes.length > 0 ? validDeliveryTimes.reduce((sum, time) => sum + time, 0) / validDeliveryTimes.length : 0;
            
            const validOrderValues = data.map(row => row['客单价']).filter(price => typeof price === 'number' && !isNaN(price));
            const avgOrderValue = validOrderValues.length > 0 ? validOrderValues.reduce((sum, price) => sum + price, 0) / validOrderValues.length : 0;

            const validOnlineHours = data.map(row => row['在线时长(h)']).filter(h => typeof h === 'number' && !isNaN(h));
            const totalOnlineHours = validOnlineHours.reduce((sum, h) => sum + h, 0);
            const totalRiders = new Set(data.map(row => row['骑手ID'])).size;
            const avgOnlineHours = totalRiders > 0 ? totalOnlineHours / totalRiders : 0;

            processed.metrics['total-orders'] = totalOrders.toLocaleString(); 
            processed.metrics['on-time-rate'] = (onTimeOrders / totalOrders * 100).toFixed(1) + '%';
            processed.metrics['positive-review-rate'] = (positiveReviews / totalOrders * 100).toFixed(1) + '%';
            processed.metrics['avg-delivery-time'] = avgDeliveryTime.toFixed(1) + ' min';
            processed.metrics['avg-online-hours'] = avgOnlineHours.toFixed(1) + ' h';
            processed.metrics['avg-order-value'] = `¥${avgOrderValue.toFixed(2)}`;

            // Funnel data
            processed.charts.funnel = {
                '订单提交': totalOrders, 
                '支付完成': data.filter(row => row['订单状态'] === '支付完成').length,
                '配送完成': data.filter(row => row['订单状态'] === '配送完成').length,
                '用户评价': data.filter(row => row['用户评价']).length
            };
            
            // Scatter plot data generation
            const scatterData = [];
            const timeIntervals = [10, 20, 30, 40, 50, 60];
            timeIntervals.forEach(interval => {
                const subset = data.filter(d => typeof d['配送时长(min)'] === 'number' && d['配送时长(min)'] >= interval - 10 && d['配送时长(min)'] < interval);
                if (subset.length > 0) {
                    const onTimeCount = subset.filter(d => d['是否准时'] === '是').length;
                    const onTimeRate = (onTimeCount / subset.length) * 100;
                    scatterData.push({ x: interval - 5, y: parseFloat(onTimeRate.toFixed(1)) });
                }
            });
            processed.charts.efficiencyScatter = scatterData;


            // Rider Retention data (simplified mock)
            const incomeGroups = {
                '5000-7000': data.filter(r => r['骑手收入'] >= 5000 && r['骑手收入'] < 7000).length,
                '7000-10000': data.filter(r => r['骑手收入'] >= 7000 && r['骑手收入'] < 10000).length,
                '10000-15000': data.filter(r => r['骑手收入'] >= 10000 && r['骑手收入'] < 15000).length,
                '15000+': data.filter(r => r['骑手收入'] >= 15000).length,
            };
            processed.charts.riderRetention = incomeGroups;

            return processed;
        }

        function updateMetricsDisplay(data) {
            for (const key in initialMetrics) {
                document.getElementById(key).innerText = data.metrics[key] || initialMetrics[key];
            }
        }

        function updateMetricsAndCharts(data, focus) {
            updateMetricsDisplay(data);

            Object.values(charts).forEach(chart => chart.destroy());
            chartsContainer.innerHTML = '';

            if (focus === 'all') {
                chartsContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">配送时长与准时率分布</h3>
                        <canvas id="deliveryTimeChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">用户订单漏斗</h3>
                        <canvas id="funnelChart"></canvas>
                    </div>
                `;
                const validDeliveryTimes = rawData.map(row => row['配送时长(min)']).filter(time => typeof time === 'number' && !isNaN(time));
                const deliveryTimeDistributionData = [
                    validDeliveryTimes.filter(t => t < 15).length,
                    validDeliveryTimes.filter(t => t >= 15 && t < 30).length,
                    validDeliveryTimes.filter(t => t >= 30 && t < 45).length,
                    validDeliveryTimes.filter(t => t >= 45).length
                ];
                charts.deliveryTimeChart = new Chart(document.getElementById('deliveryTimeChart'), {
                    type: 'bar',
                    data: {
                        labels: ['<15min', '15-30min', '30-45min', '>45min'],
                        datasets: [{
                            label: '订单数',
                            data: deliveryTimeDistributionData,
                            backgroundColor: ['#FFD100', '#FFB800', '#FF9F00', '#FF8700'],
                        }]
                    },
                    options: { 
                        responsive: true, 
                        scales: { y: { beginAtZero: true } }, 
                        plugins: { 
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value.toLocaleString(),
                                font: { weight: 'bold' }
                            } 
                        }
                    }
                });
                charts.funnelChart = new Chart(document.getElementById('funnelChart'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.charts.funnel),
                        datasets: [{
                            label: '用户数',
                            data: Object.values(data.charts.funnel),
                            backgroundColor: '#4299E1',
                        }]
                    },
                    options: { 
                        indexAxis: 'y',
                        responsive: true,
                        scales: { x: { beginAtZero: true } },
                        plugins: { 
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'right',
                                formatter: (value) => value.toLocaleString(),
                                font: { weight: 'bold' }
                            } 
                        }
                    }
                });

            } else if (focus === 'efficiency') {
                chartsContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">配送时长与准时率分布</h3>
                        <canvas id="deliveryTimeChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">不同配送时长下准时率</h3>
                        <canvas id="onTimeRateChart"></canvas>
                    </div>
                `;
                
                const validDeliveryTimes = rawData.map(row => row['配送时长(min)']).filter(time => typeof time === 'number' && !isNaN(time));
                const deliveryTimeDistributionData = [
                    validDeliveryTimes.filter(t => t < 15).length,
                    validDeliveryTimes.filter(t => t >= 15 && t < 30).length,
                    validDeliveryTimes.filter(t => t >= 30 && t < 45).length,
                    validDeliveryTimes.filter(t => t >= 45).length
                ];
                
                const labels = ['<15min', '15-30min', '30-45min', '>45min'];
                
                charts.deliveryTimeChart = new Chart(document.getElementById('deliveryTimeChart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '订单数',
                            data: deliveryTimeDistributionData,
                            backgroundColor: ['#FFD100', '#FFB800', '#FF9F00', '#FF8700'],
                        }]
                    },
                    options: { 
                        responsive: true, 
                        scales: { y: { beginAtZero: true } }, 
                        plugins: { 
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value.toLocaleString(),
                                font: { weight: 'bold' }
                            } 
                        }
                    }
                });
                
                const onTimeRateData = labels.map((label, index) => {
                    let totalOrders = 0;
                    let onTimeOrders = 0;
                    
                    if (index === 0) { // <15min
                        totalOrders = rawData.filter(d => typeof d['配送时长(min)'] === 'number' && d['配送时长(min)'] < 15).length;
                        onTimeOrders = rawData.filter(d => typeof d['配送时长(min)'] === 'number' && d['配送时长(min)'] < 15 && d['是否准时'] === '是').length;
                    } else if (index === 1) { // 15-30min
                        totalOrders = rawData.filter(d => typeof d['配送时长(min)'] === 'number' && d['配送时长(min)'] >= 15 && d['配送时长(min)'] < 30).length;
                        onTimeOrders = rawData.filter(d => typeof d['配送时长(min)'] === 'number' && d['配送时长(min)'] >= 15 && d['配送时长(min)'] < 30 && d['是否准时'] === '是').length;
                    } else if (index === 2) { // 30-45min
                        totalOrders = rawData.filter(d => typeof d['配送时长(min)'] === 'number' && d['配送时长(min)'] >= 30 && d['配送时长(min)'] < 45).length;
                        onTimeOrders = rawData.filter(d => typeof d['配送时长(min)'] === 'number' && d['配送时长(min)'] >= 30 && d['配送时长(min)'] < 45 && d['是否准时'] === '是').length;
                    } else if (index === 3) { // >45min
                        totalOrders = rawData.filter(d => typeof d['配送时长(min)'] === 'number' && d['配送时长(min)'] >= 45).length;
                        onTimeOrders = rawData.filter(d => typeof d['配送时长(min)'] === 'number' && d['配送时长(min)'] >= 45 && d['是否准时'] === '是').length;
                    }
                    
                    return totalOrders > 0 ? (onTimeOrders / totalOrders) * 100 : 0;
                });
                
                charts.onTimeRateChart = new Chart(document.getElementById('onTimeRateChart'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '准时率',
                            data: onTimeRateData,
                            borderColor: '#4299E1',
                            backgroundColor: 'rgba(66, 153, 225, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: { display: true, text: '准时率 (%)' }
                            }
                        },
                        plugins: {
                            datalabels: {
                                formatter: (value) => `${value.toFixed(1)}%`,
                                font: { weight: 'bold' }
                            }
                        }
                    }
                });

            } else if (focus === 'funnel') {
                chartsContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">用户订单漏斗</h3>
                        <canvas id="funnelChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">订单状态转化率</h3>
                        <canvas id="funnelPieChart"></canvas>
                    </div>
                `;
                
                const funnelData = [
                    { label: '订单提交', value: data.charts.funnel['订单提交'] },
                    { label: '支付完成', value: data.charts.funnel['支付完成'] },
                    { label: '配送完成', value: data.charts.funnel['配送完成'] },
                    { label: '用户评价', value: data.charts.funnel['用户评价'] }
                ];
                
                charts.funnelChart = new Chart(document.getElementById('funnelChart'), {
                    type: 'bar',
                    data: {
                        labels: funnelData.map(d => d.label),
                        datasets: [{
                            data: funnelData.map(d => d.value),
                            backgroundColor: ['#4299E1', '#63B3ED', '#80A5D2', '#C4D7F2'],
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        scales: {
                            x: {
                                beginAtZero: true,
                            },
                        },
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                color: '#fff',
                                formatter: (value) => value.toLocaleString(),
                                font: { weight: 'bold', size: 14 },
                                anchor: 'end',
                                align: 'right'
                            }
                        }
                    }
                });


                const funnelValues = Object.values(data.charts.funnel);
                const conversionRates = [
                    (funnelValues[1] / funnelValues[0]) * 100,
                    (funnelValues[2] / funnelValues[1]) * 100,
                    (funnelValues[3] / funnelValues[2]) * 100
                ];

                charts.funnelPieChart = new Chart(document.getElementById('funnelPieChart'), {
                    type: 'pie',
                    data: {
                        labels: ['支付转化率', '配送完成率', '评价转化率'],
                        datasets: [{
                            label: '转化率',
                            data: conversionRates,
                            backgroundColor: ['#FFD100', '#4299E1', '#E53E3E'],
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { 
                            legend: { position: 'top' },
                            datalabels: {
                                color: '#fff',
                                formatter: (value) => `${value.toFixed(1)}%`,
                                font: { weight: 'bold', size: 14 }
                            }
                        } 
                    }
                });

            } else if (focus === 'retention') {
                chartsContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">骑手收入群体分布</h3>
                        <canvas id="incomePieChart"></canvas>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">骑手活跃时长分布</h3>
                        <canvas id="onlineHoursChart"></canvas>
                    </div>
                `;
                charts.incomePieChart = new Chart(document.getElementById('incomePieChart'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(data.charts.riderRetention),
                        datasets: [{
                            label: '骑手数量',
                            data: Object.values(data.charts.riderRetention),
                            backgroundColor: ['#4299E1', '#63B3ED', '#80A5D2', '#C4D7F2'],
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { 
                            legend: { position: 'top' },
                            datalabels: {
                                color: '#fff',
                                formatter: (value) => value.toLocaleString(),
                                font: { weight: 'bold', size: 14 }
                            }
                        } 
                    }
                });
                const onlineHoursLabels = ['< 5h', '5-10h', '10-15h', '> 15h'];
                const onlineHoursData = [
                    rawData.filter(d => d['在线时长(h)'] < 5).length,
                    rawData.filter(d => d['在线时长(h)'] >= 5 && d['在线时长(h)'] < 10).length,
                    rawData.filter(d => d['在线时长(h)'] >= 10 && d['在线时长(h)'] < 15).length,
                    rawData.filter(d => d['在线时长(h)'] >= 15).length
                ];
                charts.onlineHoursChart = new Chart(document.getElementById('onlineHoursChart'), {
                    type: 'bar',
                    data: {
                        labels: onlineHoursLabels,
                        datasets: [{
                            label: '骑手数量',
                            data: onlineHoursData,
                            backgroundColor: '#FFD100',
                        }]
                    },
                    options: { 
                        responsive: true, 
                        scales: { y: { beginAtZero: true } }, 
                        plugins: { 
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value.toLocaleString(),
                                font: { weight: 'bold' }
                            }
                        } 
                    }
                });
            }
        }
        
        async function fetchAIReport(prompt) {
            const mockResponses = {
                'all': `
                    <p class="font-bold text-lg mb-2">全面运营分析报告</p>
                    <p>通过对美团骑手配送数据的全面分析，我们发现以下核心洞察：</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><span class="font-semibold text-red-600">问题发现：</span> **订单流失集中在支付与配送环节**。数据漏斗显示，从“订单提交”到“支付完成”存在显著流失，配送完成率也低于预期。这可能与支付系统体验不佳或高峰时段运力不足有关。</li>
                        <li><span class="font-semibold text-green-600">积极信号：</span> **用户好评率和客单价表现良好。** 这表明核心服务质量得到了用户的认可，有潜力通过优化关键环节来提升整体收益。</li>
                        <li><span class="font-semibold text-purple-600">潜在风险：</span> **不同区域的配送效率差异显著**。报告显示，部分区域在恶劣天气或高峰期时，平均配送时长大幅增加，影响了用户体验。</li>
                    </ul>
                    <p class="font-bold text-lg mt-4 mb-2">优化建议：</p>
                    <ol class="list-decimal list-inside space-y-1">
                        <li>**【提升支付转化】** 优化APP支付流程，减少步骤，提供多样的支付方式，降低用户在支付环节的流失。</li>
                        <li>**【精细化运力调度】** 利用更智能的调度算法，结合区域、天气、订单量等变量，合理分配订单，提升高峰期准时率。</li>
                        <li>**【优化骑手激励体系】** 针对骑手收入和在线时长，设计更具吸引力的激励机制，确保关键时段的运力充足和骑手留存。</li>
                    </ol>
                    <p class="mt-4 text-sm text-gray-500 italic">（由AI智能生成，仅供参考。更多细节需结合具体业务场景进行分析。）</p>
                `,
                'efficiency': `
                    <p class="font-bold text-lg mb-2">配送效率专题分析</p>
                    <p>本次分析聚焦于配送效率相关指标，我们发现：</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><span class="font-semibold text-red-600">核心问题：</span> **准时率波动明显，特别是在高峰期。** 数据显示，超过45分钟的配送订单占比异常升高，这直接影响了准时率和用户体验。</li>
                        <li><span class="font-semibold text-green-600">正面表现：</span> **大部分订单仍保持在30分钟内完成。** 这表明核心配送体系是健康的，问题主要出现在特定场景和极端情况。</li>
                    </ul>
                    <p class="font-bold text-lg mt-4 mb-2">优化建议：</p>
                    <ol class="list-decimal list-inside space-y-1">
                        <li>**【强化高峰期预警】** 建立基于大数据和AI的预测模型，提前预判高峰期订单量和运力缺口，进行前置调度。</li>
                        <li>**【优化配送路径算法】** 引入实时路况和天气数据，为骑手提供最优路径规划，减少因交通拥堵导致的延迟。</li>
                        <li>**【差异化激励】** 针对高峰期完成的订单，提供额外奖励，激励骑手积极接单，提高整体配送效率。</li>
                    </ol>
                    <p class="mt-4 text-sm text-gray-500 italic">（由AI智能生成，仅供参考。更多细节需结合具体业务场景进行分析。）</p>
                `,
                'funnel': `
                    <p class="font-bold text-lg mb-2">用户漏斗分析报告</p>
                    <p>通过对订单流程的漏斗分析，我们发现：</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><span class="font-semibold text-red-600">核心问题：</span> **订单提交后至支付完成的流失率最高。** 这表明用户在支付环节存在较大障碍，可能由支付方式不便、加载过慢或支付失败等问题引起。</li>
                        <li><span class="font-semibold text-green-600">正面表现：</span> **从配送完成到用户评价的转化率较高。** 这说明美团的服务质量在最终环节得到了用户的认可，用户体验较好。</li>
                    </ul>
                    <p class="font-bold text-lg mt-4 mb-2">优化建议：</p>
                    <ol class="list-decimal list-inside space-y-1">
                        <li>**【简化支付流程】** 优化APP支付界面，支持多种快捷支付方式，减少不必要的跳转和操作步骤。</li>
                        <li>**【追踪支付失败原因】** 搭建支付失败原因监控系统，实时追踪并定位支付断点，快速响应并解决技术问题。</li>
                        <li>**【用户留存激励】** 针对已完成支付但未评价的用户，通过消息推送、积分奖励等方式，引导其完成评价，提升数据完整性。</li>
                    </ol>
                    <p class="mt-4 text-sm text-gray-500 italic">（由AI智能生成，仅供参考。更多细节需结合具体业务场景进行分析。）</p>
                `,
                'retention': `
                    <p class="font-bold text-lg mb-2">骑手留存专题分析</p>
                    <p>通过对骑手数据的分析，我们发现：</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><span class="font-semibold text-red-600">核心问题：</span> **新骑手的早期流失率偏高。** 新注册骑手在上线初期在线时长短、接单量少，导致收入不稳定，是影响留存的关键因素。</li>
                        <li><span class="font-semibold text-green-600">正面表现：</span> **高收入骑手的在线时长和留存率成正比。** 这表明收入是激励骑手，提升其活跃度的最直接、最有效的手段。</li>
                    </ul>
                    <p class="font-bold text-lg mt-4 mb-2">优化建议：</p>
                    <ol class="list-decimal list-inside space-y-1">
                        <li>**【新手扶持计划】** 为新骑手提供额外的任务奖励和新手期保底收入，帮助他们顺利度过适应期。</li>
                        <li>**【动态薪酬体系】** 针对不同时段、不同区域的订单，设计动态的收入结构，让骑手在不同条件下都能获得合理回报。</li>
                        <li>**【完善骑手社区】** 建立线上线下骑手交流社群，分享经验、提供支持，增强骑手归属感，降低流失率。</li>
                    </ol>
                    <p class="mt-4 text-sm text-gray-500 italic">（由AI智能生成，仅供参考。更多细节需结合具体业务场景进行分析。）</p>
                `
            };
            await new Promise(resolve => setTimeout(resolve, 2000));
            return mockResponses[document.getElementById('analysis-focus-select').value];
        }

        function createAIPrompt(data, focus) {
            let analysisFocusText = '';
            if (focus === 'efficiency') analysisFocusText = '重点关注配送效率、准时率、骑手在线时长等指标。';
            if (focus === 'funnel') analysisFocusText = '重点进行用户订单流程漏斗分析，找出流失点。';
            if (focus === 'retention') analysisFocusText = '重点分析骑手收入、在线时长、订单量等数据，提出骑手留存策略。';
            
            const prompt = `
                你是一名美团业务运营管理专家，请根据以下运营数据，结合美团业务场景，生成一份专业的运营报告。${analysisFocusText}
                
                数据概览:
                - 订单总数: ${data.metrics['total-orders']}
                - 平均配送时长: ${data.metrics['avg-delivery-time']}
                - 准时率: ${data.metrics['on-time-rate']}
                - 用户好评率: ${data.metrics['positive-review-rate']}
                - 骑手平均在线时长: ${data.metrics['avg-online-hours']}
                - 客单价: ${data.metrics['avg-order-value']}
                - 订单流程漏斗: ${JSON.stringify(data.charts.funnel)}
                - 配送时长分布: ${JSON.stringify(data.charts.deliveryTimeDistribution)}
                
                分析要求:
                1. 发现数据中的核心问题、积极信号和潜在风险。
                2. 针对性地提出4-5条具体、可落地的运营优化建议。
                3. 分析语言需专业，结构清晰，贴合互联网业务运营的思维模式。
            `;
            console.log("AI Prompt:", prompt);
            return prompt;
        }

        function createMockCsvFile() {
            const numRows = 8000;
            const headers = ['订单ID', '订单状态', '配送时长(min)', '是否准时', '用户评价', '客单价', '骑手ID', '在线时长(h)', '骑手收入', '用户地域', '商家类型', '订单类型', '天气', '高峰时段(是/否)', '用户年龄段'];
            const statuses = ['订单提交', '支付完成', '配送完成', '支付失败'];
            const reviews = ['好评', '中评', '差评'];
            const regions = ['海淀区', '朝阳区', '丰台区', '昌平区', '西城区'];
            const weather = ['晴', '小雨', '大雨', '多云', '雾霾'];
            const orderTypes = ['美食', '超市', '药品', '鲜花', '生鲜'];
            const incomeLevels = [5000, 7000, 10000, 15000];
            const ageGroups = ['18-24', '25-35', '36-45', '46+'];

            const riderIds = Array.from({length: 1500}, (_, i) => `Rider${i + 1}`);

            let csvContent = '\uFEFF' + headers.join(',') + '\n'; // Add BOM for Chinese characters
            for (let i = 0; i < numRows; i++) {
                const orderId = `O${i + 1}`;
                const statusIndex = Math.floor(Math.random() * statuses.length);
                let status = statuses[statusIndex];
                
                const riderId = riderIds[Math.floor(Math.random() * riderIds.length)];
                
                let deliveryTime = '';
                let onTime = '';
                let review = '';
                let onlineHours = (Math.random() * 10 + 5).toFixed(1);
                let riderIncome = incomeLevels[Math.floor(Math.random() * incomeLevels.length)];
                
                if (status === '配送完成') {
                    deliveryTime = Math.floor(Math.random() * 60) + 1;
                    // 细化准时率判断，引入随机性
                    if (deliveryTime <= 15) {
                        onTime = '是';
                    } else if (deliveryTime > 15 && deliveryTime <= 30) {
                        onTime = Math.random() > 0.1 ? '是' : '否'; // 10%概率超时
                    } else if (deliveryTime > 30 && deliveryTime <= 45) {
                        onTime = Math.random() > 0.5 ? '是' : '否'; // 50%概率超时
                    } else {
                        onTime = Math.random() > 0.8 ? '是' : '否'; // 80%概率超时
                    }
                    review = Math.random() > 0.1 ? reviews[Math.floor(Math.random() * reviews.length)] : '';
                }

                const price = Math.floor(Math.random() * 200) + 20;
                const userRegion = regions[Math.floor(Math.random() * regions.length)];
                const merchantType = orderTypes[Math.floor(Math.random() * orderTypes.length)];
                const weatherCondition = weather[Math.floor(Math.random() * weather.length)];
                const peakHour = Math.random() > 0.7 ? '是' : '否';
                const userAgeGroup = ageGroups[Math.floor(Math.random() * ageGroups.length)];

                csvContent += `${orderId},${status},${deliveryTime},${onTime},${review},${price},${riderId},${onlineHours},${riderIncome},${userRegion},${merchantType},${weatherCondition},${peakHour},${userAgeGroup}\n`;
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "美团运营数据_示例.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        const mockDataLink = document.createElement('a');
        mockDataLink.href = '#';
        mockDataLink.innerText = '下载示例数据';
        mockDataLink.className = 'text-blue-500 hover:text-blue-600 font-semibold underline mt-4 inline-block';
        mockDataLink.onclick = (e) => {
            e.preventDefault();
            createMockCsvFile();
        };
        document.getElementById('file-upload').parentNode.parentNode.appendChild(mockDataLink);
    });
</script>
</body>
</html>
